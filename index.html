<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Interlaced Bible App</title>
  <script>
    (function () {
      // Replace with your GA4 Measurement ID, e.g. "G-ABC123XYZ9".
      const MEASUREMENT_ID = 'G-R4QL988F3S';
      if (!/^G-[A-Z0-9]+$/i.test(MEASUREMENT_ID)) {
        return;
      }

      window.dataLayer = window.dataLayer || [];
      function gtag() {
        window.dataLayer.push(arguments);
      }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', MEASUREMENT_ID);

      const script = document.createElement('script');
      script.async = true;
      script.src = `https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(MEASUREMENT_ID)}`;
      document.head.appendChild(script);
    })();
  </script>
  <style>
    :root {
      --bg: #eaf5ff;
      --panel: #f8fcff;
      --text: #102133;
      --muted: #4a647a;
      --line: #c6dff3;
      --accent: #1b5fa8;
      --accent-2: #0c8aa8;
      --bg-glow-1: #cde7ff;
      --bg-glow-2: #dff1ff;
      --surface-solid: #ffffff;
      --chapter-title-color: #164b82;
      --row-line: #d8e8f7;
      --verse-no-color: #35536f;
      --verse-no-bg-top: #edf7ff;
      --verse-no-bg-bottom: #e2f1ff;
      --entity-color: #1b5fa8;
      --missing-color: #5e7991;
      --modal-overlay: rgba(10, 28, 46, 0.38);
      --error: #8d1d1d;
      --ok: #1f6a2f;
      --verse-font-size: 0.97rem;
    }

    [data-theme="dark"] {
      --bg: #0c1724;
      --panel: #132437;
      --text: #e3edf8;
      --muted: #9eb2c8;
      --line: #2b4460;
      --accent: #79b6ff;
      --accent-2: #53d0e4;
      --bg-glow-1: #10253a;
      --bg-glow-2: #0f2234;
      --surface-solid: #0f2032;
      --chapter-title-color: #9cc9ff;
      --row-line: #28405a;
      --verse-no-color: #bad5f1;
      --verse-no-bg-top: #173049;
      --verse-no-bg-bottom: #12283d;
      --entity-color: #8ec4ff;
      --missing-color: #8ea7c1;
      --modal-overlay: rgba(3, 10, 18, 0.65);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Avenir Next", "PingFang TC", "Noto Sans CJK TC", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 95% -10%, var(--bg-glow-1) 0%, transparent 60%),
        radial-gradient(900px 600px at -5% 5%, var(--bg-glow-2) 0%, transparent 50%),
        var(--bg);
      min-height: 100vh;
    }

    .app {
      max-width: 1080px;
      margin: 0 auto;
      padding: 20px 14px 24px;
    }

    .header {
      margin-bottom: 14px;
    }

    .title {
      margin: 0;
      font-size: clamp(1.4rem, 2.6vw, 2rem);
      line-height: 1.2;
      letter-spacing: 0.02em;
      cursor: pointer;
    }

    .subtitle {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--panel);
      box-shadow: 0 8px 30px rgba(14, 58, 105, 0.08);
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(4px);
    }

    select {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.95rem;
      font-family: inherit;
      background: var(--surface-solid);
      color: var(--text);
    }

    .chapter-controls {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .chapter-picker {
      min-width: 150px;
    }

    .font-controls {
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: flex-end;
    }

    .font-btn {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--surface-solid);
      color: var(--text);
      padding: 8px 10px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      min-width: 44px;
    }

    .chapter-btn {
      min-width: 40px;
      padding: 8px 8px;
      font-size: 1rem;
      line-height: 1;
    }

    .font-btn:hover {
      border-color: var(--accent);
    }

    .font-btn:disabled {
      opacity: 0.45;
      cursor: default;
    }

    .chapter-title {
      margin: 16px 0 8px;
      font-size: 1.05rem;
      color: var(--chapter-title-color);
      font-weight: 700;
    }

    .verses {
      margin-top: 8px;
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      background: var(--panel);
    }

    .verse-row {
      display: grid;
      grid-template-columns: 58px 1fr;
      gap: 0;
      border-top: 1px solid var(--row-line);
    }

    .verse-row:first-child {
      border-top: none;
    }

    .verse-no {
      padding: 10px 8px;
      text-align: center;
      font-size: 0.85rem;
      color: var(--verse-no-color);
      border-right: 1px solid var(--row-line);
      background: linear-gradient(180deg, var(--verse-no-bg-top) 0%, var(--verse-no-bg-bottom) 100%);
      font-variant-numeric: tabular-nums;
      font-weight: 700;
    }

    .verse-content {
      padding: 10px 12px;
      display: grid;
      gap: 8px;
    }

    .translation {
      display: grid;
      gap: 2px;
    }

    .tag {
      font-size: 0.73rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-weight: 700;
    }

    .tag.nasb { color: var(--accent); }
    .tag.cunp { color: var(--accent-2); }

    .verse-text {
      line-height: 1.5;
      font-size: var(--verse-font-size);
      word-break: break-word;
    }

    .verse-text .entity {
      color: var(--entity-color);
      font-weight: 700;
    }

    .missing {
      color: var(--missing-color);
      font-style: italic;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: var(--modal-overlay);
      z-index: 20;
      padding: 16px;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      width: min(460px, 100%);
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 22px 18px;
      box-shadow: 0 14px 40px rgba(10, 40, 80, 0.22);
      text-align: center;
      color: var(--text);
      font-size: 1.05rem;
      font-weight: 600;
    }

    @media (max-width: 760px) {
      .controls {
        grid-template-columns: 1fr;
      }

      .chapter-controls {
        justify-content: flex-start;
      }

      .font-controls {
        justify-content: flex-start;
      }

      .verse-row {
        grid-template-columns: 46px 1fr;
      }

      .verse-content {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <header class="header">
      <h1 id="appTitle" class="title">Interlaced NASB+CUNP Bible</h1>
    </header>

    <section class="controls" aria-label="Controls">
      <select id="bookSelect" disabled aria-label="Book"></select>
      <div class="chapter-controls" aria-label="Chapter navigation controls">
        <button id="chapterPrev" class="font-btn chapter-btn" type="button" aria-label="Previous chapter">&larr;</button>
        <select id="chapterSelect" class="chapter-picker" disabled aria-label="Chapter"></select>
        <button id="chapterNext" class="font-btn chapter-btn" type="button" aria-label="Next chapter">&rarr;</button>
      </div>
      <div class="font-controls" aria-label="Font size controls">
        <button id="fontDown" class="font-btn" type="button" aria-label="Decrease font size">A-</button>
        <button id="fontUp" class="font-btn" type="button" aria-label="Increase font size">A+</button>
        <button id="themeToggle" class="font-btn" type="button" aria-label="Toggle dark mode">Dark</button>
      </div>
    </section>

    <h2 id="chapterTitle" class="chapter-title"></h2>
    <section id="verses" class="verses" aria-live="polite"></section>
  </main>

  <div id="titleModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Dedication">
      for my loving wife ❤️ Acts 17:11 
    </div>
  </div>

  <script>
    (function () {
      const BOOKS = [
        { id: 1, en: 'Genesis', zh: '創世記' },
        { id: 2, en: 'Exodus', zh: '出埃及記' },
        { id: 3, en: 'Leviticus', zh: '利未記' },
        { id: 4, en: 'Numbers', zh: '民數記' },
        { id: 5, en: 'Deuteronomy', zh: '申命記' },
        { id: 6, en: 'Joshua', zh: '約書亞記' },
        { id: 7, en: 'Judges', zh: '士師記' },
        { id: 8, en: 'Ruth', zh: '路得記' },
        { id: 9, en: '1 Samuel', zh: '撒母耳記上' },
        { id: 10, en: '2 Samuel', zh: '撒母耳記下' },
        { id: 11, en: '1 Kings', zh: '列王紀上' },
        { id: 12, en: '2 Kings', zh: '列王紀下' },
        { id: 13, en: '1 Chronicles', zh: '歷代志上' },
        { id: 14, en: '2 Chronicles', zh: '歷代志下' },
        { id: 15, en: 'Ezra', zh: '以斯拉記' },
        { id: 16, en: 'Nehemiah', zh: '尼希米記' },
        { id: 17, en: 'Esther', zh: '以斯帖記' },
        { id: 18, en: 'Job', zh: '約伯記' },
        { id: 19, en: 'Psalms', zh: '詩篇' },
        { id: 20, en: 'Proverbs', zh: '箴言' },
        { id: 21, en: 'Ecclesiastes', zh: '傳道書' },
        { id: 22, en: 'Song of Solomon', zh: '雅歌' },
        { id: 23, en: 'Isaiah', zh: '以賽亞書' },
        { id: 24, en: 'Jeremiah', zh: '耶利米書' },
        { id: 25, en: 'Lamentations', zh: '耶利米哀歌' },
        { id: 26, en: 'Ezekiel', zh: '以西結書' },
        { id: 27, en: 'Daniel', zh: '但以理書' },
        { id: 28, en: 'Hosea', zh: '何西阿書' },
        { id: 29, en: 'Joel', zh: '約珥書' },
        { id: 30, en: 'Amos', zh: '阿摩司書' },
        { id: 31, en: 'Obadiah', zh: '俄巴底亞書' },
        { id: 32, en: 'Jonah', zh: '約拿書' },
        { id: 33, en: 'Micah', zh: '彌迦書' },
        { id: 34, en: 'Nahum', zh: '那鴻書' },
        { id: 35, en: 'Habakkuk', zh: '哈巴谷書' },
        { id: 36, en: 'Zephaniah', zh: '西番雅書' },
        { id: 37, en: 'Haggai', zh: '哈該書' },
        { id: 38, en: 'Zechariah', zh: '撒迦利亞書' },
        { id: 39, en: 'Malachi', zh: '瑪拉基書' },
        { id: 40, en: 'Matthew', zh: '馬太福音' },
        { id: 41, en: 'Mark', zh: '馬可福音' },
        { id: 42, en: 'Luke', zh: '路加福音' },
        { id: 43, en: 'John', zh: '約翰福音' },
        { id: 44, en: 'Acts', zh: '使徒行傳' },
        { id: 45, en: 'Romans', zh: '羅馬書' },
        { id: 46, en: '1 Corinthians', zh: '哥林多前書' },
        { id: 47, en: '2 Corinthians', zh: '哥林多後書' },
        { id: 48, en: 'Galatians', zh: '加拉太書' },
        { id: 49, en: 'Ephesians', zh: '以弗所書' },
        { id: 50, en: 'Philippians', zh: '腓立比書' },
        { id: 51, en: 'Colossians', zh: '歌羅西書' },
        { id: 52, en: '1 Thessalonians', zh: '帖撒羅尼迦前書' },
        { id: 53, en: '2 Thessalonians', zh: '帖撒羅尼迦後書' },
        { id: 54, en: '1 Timothy', zh: '提摩太前書' },
        { id: 55, en: '2 Timothy', zh: '提摩太後書' },
        { id: 56, en: 'Titus', zh: '提多書' },
        { id: 57, en: 'Philemon', zh: '腓利門書' },
        { id: 58, en: 'Hebrews', zh: '希伯來書' },
        { id: 59, en: 'James', zh: '雅各書' },
        { id: 60, en: '1 Peter', zh: '彼得前書' },
        { id: 61, en: '2 Peter', zh: '彼得後書' },
        { id: 62, en: '1 John', zh: '約翰一書' },
        { id: 63, en: '2 John', zh: '約翰二書' },
        { id: 64, en: '3 John', zh: '約翰三書' },
        { id: 65, en: 'Jude', zh: '猶大書' },
        { id: 66, en: 'Revelation', zh: '啟示錄' }
      ];

      const state = {
        assetBasePath: null,
        nasbIndex: null,
        cunpIndex: null,
        loadedScriptKeys: new Set()
      };
      const FONT_STORAGE_KEY = 'interlaced_font_size_rem';
      const LOCATION_STORAGE_KEY = 'interlaced_reading_location';
      const THEME_STORAGE_KEY = 'interlaced_theme';
      const FONT_MIN = 0.85;
      const FONT_STEP = 0.05;
      const FONT_DEFAULT = 0.97;

      const bookSelect = document.getElementById('bookSelect');
      const chapterSelect = document.getElementById('chapterSelect');
      const appTitleEl = document.getElementById('appTitle');
      const titleModalBackdropEl = document.getElementById('titleModalBackdrop');
      const chapterPrevBtn = document.getElementById('chapterPrev');
      const chapterNextBtn = document.getElementById('chapterNext');
      const fontDownBtn = document.getElementById('fontDown');
      const fontUpBtn = document.getElementById('fontUp');
      const themeToggleBtn = document.getElementById('themeToggle');
      const chapterTitleEl = document.getElementById('chapterTitle');
      const versesEl = document.getElementById('verses');

      function openTitleModal() {
        titleModalBackdropEl.classList.add('open');
        titleModalBackdropEl.setAttribute('aria-hidden', 'false');
      }

      function closeTitleModal() {
        titleModalBackdropEl.classList.remove('open');
        titleModalBackdropEl.setAttribute('aria-hidden', 'true');
      }

      function getSystemTheme() {
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      function updateThemeToggleLabel(theme) {
        themeToggleBtn.textContent = theme === 'dark' ? 'Light' : 'Dark';
      }

      function applyTheme(theme) {
        const resolvedTheme = theme === 'dark' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', resolvedTheme);
        updateThemeToggleLabel(resolvedTheme);
      }

      function loadInitialTheme() {
        let theme = null;
        try {
          theme = localStorage.getItem(THEME_STORAGE_KEY);
        } catch {
          // ignore storage failures
        }
        if (theme !== 'light' && theme !== 'dark') {
          theme = getSystemTheme();
        }
        applyTheme(theme);
      }

      function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        try {
          localStorage.setItem(THEME_STORAGE_KEY, next);
        } catch {
          // ignore storage failures
        }
      }

      function clampFontSize(value) {
        return Math.max(FONT_MIN, value);
      }

      function applyFontSize(size) {
        const clamped = clampFontSize(size);
        document.documentElement.style.setProperty('--verse-font-size', `${clamped.toFixed(2)}rem`);
        try {
          localStorage.setItem(FONT_STORAGE_KEY, String(clamped));
        } catch {
          // ignore storage failures
        }
      }

      function loadInitialFontSize() {
        let size = FONT_DEFAULT;
        try {
          const raw = localStorage.getItem(FONT_STORAGE_KEY);
          const parsed = raw === null ? NaN : Number.parseFloat(raw);
          if (Number.isFinite(parsed)) {
            size = parsed;
          }
        } catch {
          // ignore storage failures
        }
        applyFontSize(size);
      }

      function adjustFontSize(delta) {
        const current = Number.parseFloat(
          getComputedStyle(document.documentElement).getPropertyValue('--verse-font-size')
        );
        const fallback = Number.isFinite(current) ? current : FONT_DEFAULT;
        applyFontSize(fallback + delta);
      }

      function saveReadingLocation() {
        if (!bookSelect.value || !chapterSelect.value) {
          return;
        }
        try {
          localStorage.setItem(
            LOCATION_STORAGE_KEY,
            JSON.stringify({
              bookId: String(bookSelect.value),
              chapterId: String(chapterSelect.value)
            })
          );
        } catch {
          // ignore storage failures
        }
      }

      function loadSavedReadingLocation() {
        try {
          const raw = localStorage.getItem(LOCATION_STORAGE_KEY);
          if (!raw) {
            return null;
          }
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object') {
            return null;
          }
          if (!parsed.bookId || !parsed.chapterId) {
            return null;
          }
          return {
            bookId: String(parsed.bookId),
            chapterId: String(parsed.chapterId)
          };
        } catch {
          return null;
        }
      }

      function clearVerses() {
        versesEl.innerHTML = '';
        chapterTitleEl.textContent = '';
      }

      async function readJsonWithFetch(url) {
        const response = await fetch(url, { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Failed to load ${url} (${response.status})`);
        }
        return response.json();
      }

      async function readJsonWithXhr(url) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', url, true);
          xhr.responseType = 'text';
          xhr.onload = function () {
            if (xhr.status === 0 || (xhr.status >= 200 && xhr.status < 300)) {
              try {
                resolve(JSON.parse(xhr.responseText));
              } catch {
                reject(new Error(`Invalid JSON in ${url}`));
              }
              return;
            }
            reject(new Error(`Failed to load ${url} (${xhr.status})`));
          };
          xhr.onerror = function () {
            reject(new Error(`Network error while loading ${url}`));
          };
          xhr.send();
        });
      }

      function relJsonToKey(relPath) {
        return relPath.replace(/\.json$/i, '');
      }

      function ensureAssetStore() {
        if (!window.__BIBLE_APP_ASSETS) {
          window.__BIBLE_APP_ASSETS = Object.create(null);
        }
        return window.__BIBLE_APP_ASSETS;
      }

      async function loadScriptAsset(relPath) {
        const key = relJsonToKey(relPath);
        const store = ensureAssetStore();
        if (Object.prototype.hasOwnProperty.call(store, key)) {
          return store[key];
        }

        const url = `${state.assetBasePath}/${key}.js`;
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = url;
          script.async = true;
          script.onload = () => resolve();
          script.onerror = () => reject(new Error(`Script load failed: ${url}`));
          document.head.appendChild(script);
        });

        state.loadedScriptKeys.add(key);

        if (!Object.prototype.hasOwnProperty.call(store, key)) {
          throw new Error(`Asset key missing after script load: ${key}`);
        }
        return store[key];
      }

      async function fetchJson(relPath) {
        if (!state.assetBasePath) {
          throw new Error('Asset base path not resolved.');
        }
        const url = `${state.assetBasePath}/${relPath}`;

        try {
          return await readJsonWithFetch(url);
        } catch (fetchError) {
          try {
            return await readJsonWithXhr(url);
          } catch {
            try {
              return await loadScriptAsset(relPath);
            } catch {
              throw fetchError;
            }
          }
        }
      }

      async function detectAssetBasePath() {
        const candidates = ['assets', './assets', '../assets'];
        for (const base of candidates) {
          try {
            state.assetBasePath = base;
            await fetchJson('nasb/index.json');
            await fetchJson('cunp/index.json');
            if (state.assetBasePath) {
              return base;
            }
          } catch {
            // continue trying other candidate paths
          }
        }
        throw new Error('Could not find readable assets path. Keep index.html next to assets folder.');
      }

      function getBookLabel(bookNumber) {
        const book = BOOKS.find((b) => b.id === Number(bookNumber));
        if (!book) {
          return `Book ${bookNumber}`;
        }
        return `${book.en} (${book.zh})`;
      }

      function populateBookSelect() {
        bookSelect.innerHTML = '';
        for (const book of state.nasbIndex.books) {
          const option = document.createElement('option');
          option.value = book.bookId;
          option.textContent = getBookLabel(book.book);
          bookSelect.appendChild(option);
        }
        bookSelect.disabled = false;
      }

      function restoreReadingLocation() {
        const saved = loadSavedReadingLocation();
        if (!saved || !state.nasbIndex || !Array.isArray(state.nasbIndex.books)) {
          return false;
        }

        const savedBook = state.nasbIndex.books.find((book) => String(book.bookId) === saved.bookId);
        if (!savedBook) {
          return false;
        }

        bookSelect.value = saved.bookId;
        populateChapterSelect(bookSelect.value);

        const savedChapter = savedBook.chapters.find((chapter) => String(chapter.chapterId) === saved.chapterId);
        if (!savedChapter) {
          return false;
        }

        chapterSelect.value = saved.chapterId;
        updateChapterNavButtons();
        return true;
      }

      function getBookEntry(indexData, bookId) {
        return indexData.books.find((book) => book.bookId === bookId) || null;
      }

      function populateChapterSelect(bookId) {
        const nasbBook = getBookEntry(state.nasbIndex, bookId);
        chapterSelect.innerHTML = '';
        if (!nasbBook) {
          chapterSelect.disabled = true;
          chapterPrevBtn.disabled = true;
          chapterNextBtn.disabled = true;
          return;
        }

        for (const chapter of nasbBook.chapters) {
          const option = document.createElement('option');
          option.value = chapter.chapterId;
          option.textContent = `Chapter ${chapter.chapter}`;
          chapterSelect.appendChild(option);
        }

        chapterSelect.disabled = false;
        updateChapterNavButtons();
      }

      function getCurrentBookPosition() {
        if (!state.nasbIndex || !Array.isArray(state.nasbIndex.books)) {
          return -1;
        }
        return state.nasbIndex.books.findIndex((book) => String(book.bookId) === String(bookSelect.value));
      }

      function getCurrentChapterPosition(bookEntry) {
        if (!bookEntry || !Array.isArray(bookEntry.chapters)) {
          return -1;
        }
        return bookEntry.chapters.findIndex((chapter) => String(chapter.chapterId) === String(chapterSelect.value));
      }

      function updateChapterNavButtons() {
        const bookPos = getCurrentBookPosition();
        if (bookPos < 0) {
          chapterPrevBtn.disabled = true;
          chapterNextBtn.disabled = true;
          return;
        }

        const bookEntry = state.nasbIndex.books[bookPos];
        const chapterPos = getCurrentChapterPosition(bookEntry);
        if (chapterPos < 0) {
          chapterPrevBtn.disabled = true;
          chapterNextBtn.disabled = true;
          return;
        }

        const hasPrevChapter = chapterPos > 0 || bookPos > 0;
        const hasNextChapter =
          chapterPos < bookEntry.chapters.length - 1 || bookPos < state.nasbIndex.books.length - 1;

        chapterPrevBtn.disabled = !hasPrevChapter;
        chapterNextBtn.disabled = !hasNextChapter;
      }

      async function navigateChapter(direction) {
        if (!state.nasbIndex || !state.nasbIndex.books.length) {
          return;
        }

        const bookPos = getCurrentBookPosition();
        if (bookPos < 0) {
          return;
        }

        const currentBook = state.nasbIndex.books[bookPos];
        const chapterPos = getCurrentChapterPosition(currentBook);
        if (chapterPos < 0) {
          return;
        }

        let nextBookPos = bookPos;
        let nextChapterPos = chapterPos + direction;

        if (nextChapterPos < 0) {
          if (bookPos === 0) {
            return;
          }
          nextBookPos = bookPos - 1;
          nextChapterPos = state.nasbIndex.books[nextBookPos].chapters.length - 1;
        } else if (nextChapterPos >= currentBook.chapters.length) {
          if (bookPos >= state.nasbIndex.books.length - 1) {
            return;
          }
          nextBookPos = bookPos + 1;
          nextChapterPos = 0;
        }

        const nextBook = state.nasbIndex.books[nextBookPos];
        const nextChapter = nextBook.chapters[nextChapterPos];
        if (!nextBook || !nextChapter) {
          return;
        }

        if (String(bookSelect.value) !== String(nextBook.bookId)) {
          bookSelect.value = String(nextBook.bookId);
          populateChapterSelect(bookSelect.value);
        }

        chapterSelect.value = String(nextChapter.chapterId);
        updateChapterNavButtons();
        await renderCurrentChapter();
      }

      async function jumpToBookChapter(bookNumber, chapterNumber) {
        if (!state.nasbIndex || !Array.isArray(state.nasbIndex.books)) {
          return;
        }

        const targetBook = state.nasbIndex.books.find((book) => Number(book.book) === Number(bookNumber));
        if (!targetBook) {
          return;
        }

        bookSelect.value = String(targetBook.bookId);
        populateChapterSelect(bookSelect.value);

        const targetChapter = targetBook.chapters.find((chapter) => Number(chapter.chapter) === Number(chapterNumber));
        if (!targetChapter) {
          return;
        }

        chapterSelect.value = String(targetChapter.chapterId);
        updateChapterNavButtons();
        await renderCurrentChapter();
      }

      function scrollToVerse(verseNumber) {
        const verseRow = versesEl.querySelector(`.verse-row[data-verse-number="${verseNumber}"]`);
        if (!verseRow) {
          return;
        }
        verseRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function wait(ms) {
        return new Promise((resolve) => {
          setTimeout(resolve, ms);
        });
      }

      async function loadChapterVerses(translation, bookId, chapterId) {
        const indexData = translation === 'nasb' ? state.nasbIndex : state.cunpIndex;
        const book = getBookEntry(indexData, bookId);
        if (!book) {
          throw new Error(`Book ${bookId} not found in ${translation.toUpperCase()} index.`);
        }

        const chapter = book.chapters.find((entry) => entry.chapterId === chapterId);
        if (!chapter) {
          return [];
        }

        const relPath = `${translation}/${chapter.path}`;
        try {
          const data = await fetchJson(relPath);
          return Array.isArray(data) ? data : [];
        } catch {
          return [];
        }
      }

      function buildInterlacedRows(nasbVerses, cunpVerses) {
        const nasbMap = new Map();
        const cunpMap = new Map();

        for (const verse of nasbVerses) {
          nasbMap.set(Number(verse.verse), verse.text || '');
        }

        for (const verse of cunpVerses) {
          cunpMap.set(Number(verse.verse), verse.text || '');
        }

        const verseNumbers = new Set([...nasbMap.keys(), ...cunpMap.keys()]);
        return [...verseNumbers]
          .sort((a, b) => a - b)
          .map((num) => ({
            verseNumber: num,
            nasbText: nasbMap.has(num) ? nasbMap.get(num) : null,
            cunpText: cunpMap.has(num) ? cunpMap.get(num) : null
          }));
      }

      function escapeHtml(text) {
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function renderVerseTextHtml(value) {
        const escaped = escapeHtml(value);
        return escaped
          .replace(/&lt;br\s*\/?&gt;/gi, '<br>')
          .replace(/&lt;i&gt;/gi, '<i>')
          .replace(/&lt;\/i&gt;/gi, '</i>')
          .replace(/&lt;sup&gt;/gi, '<sup>')
          .replace(/&lt;\/sup&gt;/gi, '</sup>')
          .replace(/&lt;e&gt;/gi, '<span class="entity">')
          .replace(/&lt;\/e&gt;/gi, '</span>');
      }

      function createTranslationBlock(tagClass, tagText, value) {
        const wrapper = document.createElement('div');
        wrapper.className = 'translation';

        const body = document.createElement('div');
        body.className = 'verse-text';
        if (value === null || value === '') {
          body.classList.add('missing');
          body.textContent = '(missing)';
        } else {
          body.innerHTML = renderVerseTextHtml(value);
        }

        wrapper.appendChild(body);
        return wrapper;
      }

      function renderRows(rows) {
        versesEl.innerHTML = '';

        if (!rows.length) {
          const empty = document.createElement('div');
          empty.className = 'verse-row';

          const no = document.createElement('div');
          no.className = 'verse-no';
          no.textContent = '-';

          const content = document.createElement('div');
          content.className = 'verse-content';
          const text = document.createElement('div');
          text.className = 'verse-text missing';
          text.textContent = 'No verses found in this chapter.';
          content.appendChild(text);

          empty.appendChild(no);
          empty.appendChild(content);
          versesEl.appendChild(empty);
          return;
        }

        const fragment = document.createDocumentFragment();

        for (const row of rows) {
          const verseRow = document.createElement('article');
          verseRow.className = 'verse-row';
          verseRow.dataset.verseNumber = String(row.verseNumber);

          const verseNo = document.createElement('div');
          verseNo.className = 'verse-no';
          verseNo.textContent = String(row.verseNumber);

          const content = document.createElement('div');
          content.className = 'verse-content';
          content.appendChild(createTranslationBlock('nasb', 'NASB', row.nasbText));
          content.appendChild(createTranslationBlock('cunp', 'CUNP', row.cunpText));

          verseRow.appendChild(verseNo);
          verseRow.appendChild(content);
          fragment.appendChild(verseRow);
        }

        versesEl.appendChild(fragment);
      }

      async function renderCurrentChapter() {
        if (!state.nasbIndex || !state.cunpIndex) {
          return;
        }

        const bookId = bookSelect.value;
        const chapterId = chapterSelect.value;

        if (!bookId || !chapterId) {
          clearVerses();
          return;
        }

        const nasbBook = getBookEntry(state.nasbIndex, bookId);
        const chapterNumber = Number.parseInt(chapterId, 10);
        const bookNumber = nasbBook ? nasbBook.book : Number.parseInt(bookId, 10);

        chapterTitleEl.textContent = `${getBookLabel(bookNumber)} - Chapter ${chapterNumber}`;

        const [nasbVerses, cunpVerses] = await Promise.all([
          loadChapterVerses('nasb', bookId, chapterId),
          loadChapterVerses('cunp', bookId, chapterId)
        ]);

        const rows = buildInterlacedRows(nasbVerses, cunpVerses);
        renderRows(rows);
        saveReadingLocation();
      }

      async function loadIndices() {
        const [nasbIndex, cunpIndex] = await Promise.all([
          fetchJson('nasb/index.json'),
          fetchJson('cunp/index.json')
        ]);

        if (!nasbIndex || !Array.isArray(nasbIndex.books)) {
          throw new Error('Invalid nasb/index.json format.');
        }

        if (!cunpIndex || !Array.isArray(cunpIndex.books)) {
          throw new Error('Invalid cunp/index.json format.');
        }

        state.nasbIndex = nasbIndex;
        state.cunpIndex = cunpIndex;
      }

      bookSelect.addEventListener('change', async () => {
        populateChapterSelect(bookSelect.value);
        await renderCurrentChapter();
      });

      chapterSelect.addEventListener('change', async () => {
        updateChapterNavButtons();
        await renderCurrentChapter();
      });

      chapterPrevBtn.addEventListener('click', async () => {
        await navigateChapter(-1);
      });

      chapterNextBtn.addEventListener('click', async () => {
        await navigateChapter(1);
      });

      fontDownBtn.addEventListener('click', () => {
        adjustFontSize(-FONT_STEP);
      });

      fontUpBtn.addEventListener('click', () => {
        adjustFontSize(FONT_STEP);
      });

      themeToggleBtn.addEventListener('click', () => {
        toggleTheme();
      });

      appTitleEl.addEventListener('click', () => {
        (async function () {
          await jumpToBookChapter(44, 17);
          scrollToVerse(11);
          await wait(450);
          openTitleModal();
        })();
      });

      titleModalBackdropEl.addEventListener('click', (event) => {
        if (event.target === titleModalBackdropEl) {
          closeTitleModal();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && titleModalBackdropEl.classList.contains('open')) {
          closeTitleModal();
        }
      });

      clearVerses();
      loadInitialTheme();
      loadInitialFontSize();

      (async function init() {
        try {
          state.assetBasePath = await detectAssetBasePath();
          await loadIndices();
          populateBookSelect();
          if (!restoreReadingLocation()) {
            populateChapterSelect(bookSelect.value);
          }
          await renderCurrentChapter();
        } catch (error) {
          console.error(error);
          bookSelect.disabled = true;
          chapterSelect.disabled = true;
          chapterPrevBtn.disabled = true;
          chapterNextBtn.disabled = true;
        }
      })();
    })();
  </script>
</body>
</html>
