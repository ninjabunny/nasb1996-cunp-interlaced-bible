<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Interlaced Bible App</title>
  <style>
    :root {
      --bg: #f7f4ec;
      --panel: #fffdfa;
      --text: #1a1916;
      --muted: #6e6658;
      --line: #ddd2be;
      --accent: #8b5e34;
      --accent-2: #2d6670;
      --error: #8d1d1d;
      --ok: #1f6a2f;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Avenir Next", "PingFang TC", "Noto Sans CJK TC", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 95% -10%, #efe1c9 0%, transparent 60%),
        radial-gradient(900px 600px at -5% 5%, #f0eddc 0%, transparent 50%),
        var(--bg);
      min-height: 100vh;
    }

    .app {
      max-width: 1080px;
      margin: 0 auto;
      padding: 20px 14px 24px;
    }

    .header {
      margin-bottom: 14px;
    }

    .title {
      margin: 0;
      font-size: clamp(1.4rem, 2.6vw, 2rem);
      line-height: 1.2;
      letter-spacing: 0.02em;
    }

    .subtitle {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--panel);
      box-shadow: 0 8px 30px rgba(30, 26, 20, 0.06);
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(4px);
    }

    select {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.95rem;
      font-family: inherit;
      background: #fff;
      color: var(--text);
    }

    .status {
      margin-top: 10px;
      min-height: 24px;
      padding: 7px 10px;
      border-left: 3px solid var(--line);
      color: var(--muted);
      background: rgba(255, 255, 255, 0.65);
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .status.ok {
      border-left-color: var(--ok);
      color: #194f25;
    }

    .status.error {
      border-left-color: var(--error);
      color: var(--error);
    }

    .chapter-title {
      margin: 16px 0 8px;
      font-size: 1.05rem;
      color: #473522;
      font-weight: 700;
    }

    .verses {
      margin-top: 8px;
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      background: var(--panel);
    }

    .verse-row {
      display: grid;
      grid-template-columns: 58px 1fr;
      gap: 0;
      border-top: 1px solid #ebe2d2;
    }

    .verse-row:first-child {
      border-top: none;
    }

    .verse-no {
      padding: 10px 8px;
      text-align: center;
      font-size: 0.85rem;
      color: #5e5546;
      border-right: 1px solid #ebe2d2;
      background: linear-gradient(180deg, #f9f2e7 0%, #f7efe1 100%);
      font-variant-numeric: tabular-nums;
      font-weight: 700;
    }

    .verse-content {
      padding: 10px 12px;
      display: grid;
      gap: 8px;
    }

    .translation {
      display: grid;
      gap: 2px;
    }

    .tag {
      font-size: 0.73rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-weight: 700;
    }

    .tag.nasb { color: var(--accent); }
    .tag.cunp { color: var(--accent-2); }

    .verse-text {
      line-height: 1.5;
      font-size: 0.97rem;
      word-break: break-word;
    }

    .missing {
      color: #8b7d67;
      font-style: italic;
    }

    @media (max-width: 760px) {
      .controls {
        grid-template-columns: 1fr;
      }

      .verse-row {
        grid-template-columns: 46px 1fr;
      }

      .verse-content {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <header class="header">
      <h1 class="title">Interlaced Bible</h1>
      <p class="subtitle">NASB 1995 + CUNP (book/chapter view, lazy-loaded from assets)</p>
    </header>

    <section class="controls" aria-label="Controls">
      <select id="bookSelect" disabled aria-label="Book"></select>
      <select id="chapterSelect" disabled aria-label="Chapter"></select>
    </section>

    <div id="status" class="status" role="status">
      Loading Bible indexes from <code>assets/</code>...
    </div>

    <h2 id="chapterTitle" class="chapter-title"></h2>
    <section id="verses" class="verses" aria-live="polite"></section>
  </main>

  <script>
    (function () {
      const BOOKS = [
        { id: 1, en: 'Genesis', zh: '創世記' },
        { id: 2, en: 'Exodus', zh: '出埃及記' },
        { id: 3, en: 'Leviticus', zh: '利未記' },
        { id: 4, en: 'Numbers', zh: '民數記' },
        { id: 5, en: 'Deuteronomy', zh: '申命記' },
        { id: 6, en: 'Joshua', zh: '約書亞記' },
        { id: 7, en: 'Judges', zh: '士師記' },
        { id: 8, en: 'Ruth', zh: '路得記' },
        { id: 9, en: '1 Samuel', zh: '撒母耳記上' },
        { id: 10, en: '2 Samuel', zh: '撒母耳記下' },
        { id: 11, en: '1 Kings', zh: '列王紀上' },
        { id: 12, en: '2 Kings', zh: '列王紀下' },
        { id: 13, en: '1 Chronicles', zh: '歷代志上' },
        { id: 14, en: '2 Chronicles', zh: '歷代志下' },
        { id: 15, en: 'Ezra', zh: '以斯拉記' },
        { id: 16, en: 'Nehemiah', zh: '尼希米記' },
        { id: 17, en: 'Esther', zh: '以斯帖記' },
        { id: 18, en: 'Job', zh: '約伯記' },
        { id: 19, en: 'Psalms', zh: '詩篇' },
        { id: 20, en: 'Proverbs', zh: '箴言' },
        { id: 21, en: 'Ecclesiastes', zh: '傳道書' },
        { id: 22, en: 'Song of Solomon', zh: '雅歌' },
        { id: 23, en: 'Isaiah', zh: '以賽亞書' },
        { id: 24, en: 'Jeremiah', zh: '耶利米書' },
        { id: 25, en: 'Lamentations', zh: '耶利米哀歌' },
        { id: 26, en: 'Ezekiel', zh: '以西結書' },
        { id: 27, en: 'Daniel', zh: '但以理書' },
        { id: 28, en: 'Hosea', zh: '何西阿書' },
        { id: 29, en: 'Joel', zh: '約珥書' },
        { id: 30, en: 'Amos', zh: '阿摩司書' },
        { id: 31, en: 'Obadiah', zh: '俄巴底亞書' },
        { id: 32, en: 'Jonah', zh: '約拿書' },
        { id: 33, en: 'Micah', zh: '彌迦書' },
        { id: 34, en: 'Nahum', zh: '那鴻書' },
        { id: 35, en: 'Habakkuk', zh: '哈巴谷書' },
        { id: 36, en: 'Zephaniah', zh: '西番雅書' },
        { id: 37, en: 'Haggai', zh: '哈該書' },
        { id: 38, en: 'Zechariah', zh: '撒迦利亞書' },
        { id: 39, en: 'Malachi', zh: '瑪拉基書' },
        { id: 40, en: 'Matthew', zh: '馬太福音' },
        { id: 41, en: 'Mark', zh: '馬可福音' },
        { id: 42, en: 'Luke', zh: '路加福音' },
        { id: 43, en: 'John', zh: '約翰福音' },
        { id: 44, en: 'Acts', zh: '使徒行傳' },
        { id: 45, en: 'Romans', zh: '羅馬書' },
        { id: 46, en: '1 Corinthians', zh: '哥林多前書' },
        { id: 47, en: '2 Corinthians', zh: '哥林多後書' },
        { id: 48, en: 'Galatians', zh: '加拉太書' },
        { id: 49, en: 'Ephesians', zh: '以弗所書' },
        { id: 50, en: 'Philippians', zh: '腓立比書' },
        { id: 51, en: 'Colossians', zh: '歌羅西書' },
        { id: 52, en: '1 Thessalonians', zh: '帖撒羅尼迦前書' },
        { id: 53, en: '2 Thessalonians', zh: '帖撒羅尼迦後書' },
        { id: 54, en: '1 Timothy', zh: '提摩太前書' },
        { id: 55, en: '2 Timothy', zh: '提摩太後書' },
        { id: 56, en: 'Titus', zh: '提多書' },
        { id: 57, en: 'Philemon', zh: '腓利門書' },
        { id: 58, en: 'Hebrews', zh: '希伯來書' },
        { id: 59, en: 'James', zh: '雅各書' },
        { id: 60, en: '1 Peter', zh: '彼得前書' },
        { id: 61, en: '2 Peter', zh: '彼得後書' },
        { id: 62, en: '1 John', zh: '約翰一書' },
        { id: 63, en: '2 John', zh: '約翰二書' },
        { id: 64, en: '3 John', zh: '約翰三書' },
        { id: 65, en: 'Jude', zh: '猶大書' },
        { id: 66, en: 'Revelation', zh: '啟示錄' }
      ];

      const state = {
        assetBasePath: null,
        nasbIndex: null,
        cunpIndex: null,
        loadedScriptKeys: new Set()
      };

      const bookSelect = document.getElementById('bookSelect');
      const chapterSelect = document.getElementById('chapterSelect');
      const statusEl = document.getElementById('status');
      const chapterTitleEl = document.getElementById('chapterTitle');
      const versesEl = document.getElementById('verses');

      function clearVerses() {
        versesEl.innerHTML = '';
        chapterTitleEl.textContent = '';
      }

      function renderStatus(message, kind) {
        statusEl.textContent = message;
        statusEl.classList.remove('ok', 'error');
        if (kind === 'ok' || kind === 'error') {
          statusEl.classList.add(kind);
        }
      }

      async function readJsonWithFetch(url) {
        const response = await fetch(url, { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Failed to load ${url} (${response.status})`);
        }
        return response.json();
      }

      async function readJsonWithXhr(url) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', url, true);
          xhr.responseType = 'text';
          xhr.onload = function () {
            if (xhr.status === 0 || (xhr.status >= 200 && xhr.status < 300)) {
              try {
                resolve(JSON.parse(xhr.responseText));
              } catch {
                reject(new Error(`Invalid JSON in ${url}`));
              }
              return;
            }
            reject(new Error(`Failed to load ${url} (${xhr.status})`));
          };
          xhr.onerror = function () {
            reject(new Error(`Network error while loading ${url}`));
          };
          xhr.send();
        });
      }

      function relJsonToKey(relPath) {
        return relPath.replace(/\.json$/i, '');
      }

      function ensureAssetStore() {
        if (!window.__BIBLE_APP_ASSETS) {
          window.__BIBLE_APP_ASSETS = Object.create(null);
        }
        return window.__BIBLE_APP_ASSETS;
      }

      async function loadScriptAsset(relPath) {
        const key = relJsonToKey(relPath);
        const store = ensureAssetStore();
        if (Object.prototype.hasOwnProperty.call(store, key)) {
          return store[key];
        }

        const url = `${state.assetBasePath}/${key}.js`;
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = url;
          script.async = true;
          script.onload = () => resolve();
          script.onerror = () => reject(new Error(`Script load failed: ${url}`));
          document.head.appendChild(script);
        });

        state.loadedScriptKeys.add(key);

        if (!Object.prototype.hasOwnProperty.call(store, key)) {
          throw new Error(`Asset key missing after script load: ${key}`);
        }
        return store[key];
      }

      async function fetchJson(relPath) {
        if (!state.assetBasePath) {
          throw new Error('Asset base path not resolved.');
        }
        const url = `${state.assetBasePath}/${relPath}`;

        try {
          return await readJsonWithFetch(url);
        } catch (fetchError) {
          try {
            return await readJsonWithXhr(url);
          } catch {
            try {
              return await loadScriptAsset(relPath);
            } catch {
              throw fetchError;
            }
          }
        }
      }

      async function detectAssetBasePath() {
        const candidates = ['assets', './assets', '../assets'];
        for (const base of candidates) {
          try {
            state.assetBasePath = base;
            await fetchJson('nasb/index.json');
            await fetchJson('cunp/index.json');
            if (state.assetBasePath) {
              return base;
            }
          } catch {
            // continue trying other candidate paths
          }
        }
        throw new Error('Could not find readable assets path. Keep index.html next to assets folder.');
      }

      function getBookLabel(bookNumber) {
        const book = BOOKS.find((b) => b.id === Number(bookNumber));
        if (!book) {
          return `Book ${bookNumber}`;
        }
        return `${book.en} (${book.zh})`;
      }

      function populateBookSelect() {
        bookSelect.innerHTML = '';
        for (const book of state.nasbIndex.books) {
          const option = document.createElement('option');
          option.value = book.bookId;
          option.textContent = getBookLabel(book.book);
          bookSelect.appendChild(option);
        }
        bookSelect.disabled = false;
      }

      function getBookEntry(indexData, bookId) {
        return indexData.books.find((book) => book.bookId === bookId) || null;
      }

      function populateChapterSelect(bookId) {
        const nasbBook = getBookEntry(state.nasbIndex, bookId);
        chapterSelect.innerHTML = '';
        if (!nasbBook) {
          chapterSelect.disabled = true;
          return;
        }

        for (const chapter of nasbBook.chapters) {
          const option = document.createElement('option');
          option.value = chapter.chapterId;
          option.textContent = `Chapter ${chapter.chapter}`;
          chapterSelect.appendChild(option);
        }

        chapterSelect.disabled = false;
      }

      async function loadChapterVerses(translation, bookId, chapterId) {
        const indexData = translation === 'nasb' ? state.nasbIndex : state.cunpIndex;
        const book = getBookEntry(indexData, bookId);
        if (!book) {
          throw new Error(`Book ${bookId} not found in ${translation.toUpperCase()} index.`);
        }

        const chapter = book.chapters.find((entry) => entry.chapterId === chapterId);
        if (!chapter) {
          return [];
        }

        const relPath = `${translation}/${chapter.path}`;
        try {
          const data = await fetchJson(relPath);
          return Array.isArray(data) ? data : [];
        } catch {
          return [];
        }
      }

      function buildInterlacedRows(nasbVerses, cunpVerses) {
        const nasbMap = new Map();
        const cunpMap = new Map();

        for (const verse of nasbVerses) {
          nasbMap.set(Number(verse.verse), verse.text || '');
        }

        for (const verse of cunpVerses) {
          cunpMap.set(Number(verse.verse), verse.text || '');
        }

        const verseNumbers = new Set([...nasbMap.keys(), ...cunpMap.keys()]);
        return [...verseNumbers]
          .sort((a, b) => a - b)
          .map((num) => ({
            verseNumber: num,
            nasbText: nasbMap.has(num) ? nasbMap.get(num) : null,
            cunpText: cunpMap.has(num) ? cunpMap.get(num) : null
          }));
      }

      function createTranslationBlock(tagClass, tagText, value) {
        const wrapper = document.createElement('div');
        wrapper.className = 'translation';

        const tag = document.createElement('div');
        tag.className = `tag ${tagClass}`;
        tag.textContent = tagText;

        const body = document.createElement('div');
        body.className = 'verse-text';
        if (value === null || value === '') {
          body.classList.add('missing');
          body.textContent = '(missing)';
        } else {
          body.textContent = value;
        }

        wrapper.appendChild(tag);
        wrapper.appendChild(body);
        return wrapper;
      }

      function renderRows(rows) {
        versesEl.innerHTML = '';

        if (!rows.length) {
          const empty = document.createElement('div');
          empty.className = 'verse-row';

          const no = document.createElement('div');
          no.className = 'verse-no';
          no.textContent = '-';

          const content = document.createElement('div');
          content.className = 'verse-content';
          const text = document.createElement('div');
          text.className = 'verse-text missing';
          text.textContent = 'No verses found in this chapter.';
          content.appendChild(text);

          empty.appendChild(no);
          empty.appendChild(content);
          versesEl.appendChild(empty);
          return;
        }

        const fragment = document.createDocumentFragment();

        for (const row of rows) {
          const verseRow = document.createElement('article');
          verseRow.className = 'verse-row';

          const verseNo = document.createElement('div');
          verseNo.className = 'verse-no';
          verseNo.textContent = String(row.verseNumber);

          const content = document.createElement('div');
          content.className = 'verse-content';
          content.appendChild(createTranslationBlock('nasb', 'NASB', row.nasbText));
          content.appendChild(createTranslationBlock('cunp', 'CUNP', row.cunpText));

          verseRow.appendChild(verseNo);
          verseRow.appendChild(content);
          fragment.appendChild(verseRow);
        }

        versesEl.appendChild(fragment);
      }

      async function renderCurrentChapter() {
        if (!state.nasbIndex || !state.cunpIndex) {
          return;
        }

        const bookId = bookSelect.value;
        const chapterId = chapterSelect.value;

        if (!bookId || !chapterId) {
          clearVerses();
          return;
        }

        const nasbBook = getBookEntry(state.nasbIndex, bookId);
        const chapterNumber = Number.parseInt(chapterId, 10);
        const bookNumber = nasbBook ? nasbBook.book : Number.parseInt(bookId, 10);

        chapterTitleEl.textContent = `${getBookLabel(bookNumber)} - Chapter ${chapterNumber}`;
        renderStatus('Loading chapter...', null);

        const [nasbVerses, cunpVerses] = await Promise.all([
          loadChapterVerses('nasb', bookId, chapterId),
          loadChapterVerses('cunp', bookId, chapterId)
        ]);

        const rows = buildInterlacedRows(nasbVerses, cunpVerses);
        renderRows(rows);

        const nasbCount = nasbVerses.length;
        const cunpCount = cunpVerses.length;
        const mismatch = nasbCount === cunpCount ? '' : ` (mismatch: NASB ${nasbCount}, CUNP ${cunpCount})`;
        renderStatus(`Loaded ${getBookLabel(bookNumber)} Chapter ${chapterNumber}.${mismatch}`, 'ok');
      }

      async function loadIndices() {
        const [nasbIndex, cunpIndex] = await Promise.all([
          fetchJson('nasb/index.json'),
          fetchJson('cunp/index.json')
        ]);

        if (!nasbIndex || !Array.isArray(nasbIndex.books)) {
          throw new Error('Invalid nasb/index.json format.');
        }

        if (!cunpIndex || !Array.isArray(cunpIndex.books)) {
          throw new Error('Invalid cunp/index.json format.');
        }

        state.nasbIndex = nasbIndex;
        state.cunpIndex = cunpIndex;
      }

      bookSelect.addEventListener('change', async () => {
        populateChapterSelect(bookSelect.value);
        await renderCurrentChapter();
      });

      chapterSelect.addEventListener('change', async () => {
        await renderCurrentChapter();
      });

      clearVerses();

      (async function init() {
        try {
          state.assetBasePath = await detectAssetBasePath();
          await loadIndices();
          populateBookSelect();
          populateChapterSelect(bookSelect.value);
          await renderCurrentChapter();
        } catch (error) {
          renderStatus(
            `${error.message || 'Failed to load assets.'} Keep index.html beside assets/. If opened via file:// and blocked, launch Chrome with --allow-file-access-from-files.`,
            'error'
          );
          bookSelect.disabled = true;
          chapterSelect.disabled = true;
        }
      })();
    })();
  </script>
</body>
</html>
