<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Interlaced Bible App</title>
  <script>
    (function () {
      // Replace with your GA4 Measurement ID, e.g. "G-ABC123XYZ9".
      const MEASUREMENT_ID = 'G-R4QL988F3S';
      if (!/^G-[A-Z0-9]+$/i.test(MEASUREMENT_ID)) {
        return;
      }

      window.dataLayer = window.dataLayer || [];
      function gtag() {
        window.dataLayer.push(arguments);
      }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', MEASUREMENT_ID);

      const script = document.createElement('script');
      script.async = true;
      script.src = `https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(MEASUREMENT_ID)}`;
      document.head.appendChild(script);
    })();
  </script>
  <style>
    :root {
      --bg: #eaf5ff;
      --panel: #f8fcff;
      --text: #102133;
      --muted: #4a647a;
      --line: #c6dff3;
      --accent: #1b5fa8;
      --accent-2: #0c8aa8;
      --bg-glow-1: #cde7ff;
      --bg-glow-2: #dff1ff;
      --surface-solid: #ffffff;
      --chapter-title-color: #164b82;
      --row-line: #d8e8f7;
      --verse-no-color: #35536f;
      --verse-no-bg-top: #edf7ff;
      --verse-no-bg-bottom: #e2f1ff;
      --entity-color: #1b5fa8;
      --missing-color: #5e7991;
      --modal-overlay: rgba(10, 28, 46, 0.38);
      --error: #8d1d1d;
      --ok: #1f6a2f;
      --verse-font-size: 0.97rem;
      --dur-fast: 180ms;
      --dur-enter: 220ms;
      --dur-slow: 260ms;
      --ease-standard: cubic-bezier(0.2, 0, 0, 1);
      --ease-emphasized: cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    [data-theme="dark"] {
      --bg: #0c1724;
      --panel: #132437;
      --text: #e3edf8;
      --muted: #9eb2c8;
      --line: #2b4460;
      --accent: #79b6ff;
      --accent-2: #53d0e4;
      --bg-glow-1: #10253a;
      --bg-glow-2: #0f2234;
      --surface-solid: #0f2032;
      --chapter-title-color: #9cc9ff;
      --row-line: #28405a;
      --verse-no-color: #bad5f1;
      --verse-no-bg-top: #173049;
      --verse-no-bg-bottom: #12283d;
      --entity-color: #8ec4ff;
      --missing-color: #8ea7c1;
      --modal-overlay: rgba(3, 10, 18, 0.65);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Avenir Next", "PingFang TC", "Noto Sans CJK TC", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 95% -10%, var(--bg-glow-1) 0%, transparent 60%),
        radial-gradient(900px 600px at -5% 5%, var(--bg-glow-2) 0%, transparent 50%),
        var(--bg);
      min-height: 100vh;
      transition: background var(--dur-fast) var(--ease-standard), color var(--dur-fast) var(--ease-standard);
    }

    .app {
      max-width: 1080px;
      margin: 0 auto;
      padding: 20px 14px 24px;
    }

    .header {
      margin-bottom: 14px;
    }

    .title {
      margin: 0;
      font-size: clamp(1.4rem, 2.6vw, 2rem);
      line-height: 1.2;
      letter-spacing: 0.02em;
      cursor: pointer;
    }

    .subtitle {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--panel);
      box-shadow: 0 8px 30px rgba(14, 58, 105, 0.08);
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(4px);
      transition: box-shadow var(--dur-fast) var(--ease-standard), border-color var(--dur-fast) var(--ease-standard), background var(--dur-fast) var(--ease-standard);
    }

    .controls.scrolled {
      box-shadow: 0 12px 34px rgba(14, 58, 105, 0.16);
    }

    select {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.95rem;
      font-family: inherit;
      background: var(--surface-solid);
      color: var(--text);
    }

    .chapter-controls {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .chapter-picker {
      min-width: 150px;
    }

    .font-controls {
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: flex-end;
    }

    .font-btn {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--surface-solid);
      color: var(--text);
      padding: 8px 10px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      min-width: 44px;
      transition: transform var(--dur-fast) var(--ease-emphasized), border-color var(--dur-fast) var(--ease-standard), background var(--dur-fast) var(--ease-standard), color var(--dur-fast) var(--ease-standard);
    }

    .chapter-btn {
      min-width: 40px;
      padding: 8px 8px;
      font-size: 1rem;
      line-height: 1;
    }

    .font-btn:hover {
      border-color: var(--accent);
    }

    .font-btn:active {
      transform: scale(0.97);
    }

    .font-btn:disabled {
      opacity: 0.45;
      cursor: default;
    }

    .chapter-block-title {
      margin: 0;
      padding: 10px 12px;
      border-top: 1px solid var(--row-line);
      border-bottom: 1px solid var(--row-line);
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--chapter-title-color);
      background: color-mix(in srgb, var(--panel) 90%, var(--bg) 10%);
      transition: color var(--dur-fast) var(--ease-standard), background var(--dur-fast) var(--ease-standard), border-color var(--dur-fast) var(--ease-standard);
    }

    .chapter-block .chapter-block-title + .verse-row {
      border-top: none;
    }

    .verses {
      margin-top: 8px;
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      background: var(--panel);
      transition: background var(--dur-fast) var(--ease-standard), border-color var(--dur-fast) var(--ease-standard);
    }

    #scrollSentinel {
      height: 1px;
    }

    .verse-row {
      display: grid;
      grid-template-columns: 58px 1fr;
      gap: 0;
      border-top: 1px solid var(--row-line);
      cursor: pointer;
      transition: border-color var(--dur-fast) var(--ease-standard), box-shadow var(--dur-fast) var(--ease-standard), background var(--dur-fast) var(--ease-standard);
    }

    .verse-row:first-child {
      border-top: none;
    }

    .verse-no {
      padding: 10px 8px;
      text-align: center;
      font-size: 0.85rem;
      color: var(--verse-no-color);
      border-right: 1px solid var(--row-line);
      background: linear-gradient(180deg, var(--verse-no-bg-top) 0%, var(--verse-no-bg-bottom) 100%);
      font-variant-numeric: tabular-nums;
      font-weight: 700;
    }

    .verse-content {
      padding: 10px 12px;
      display: grid;
      gap: 8px;
    }

    .chapter-block.motion-enter .verse-row,
    .chapter-block.motion-enter .chapter-block-title {
      opacity: 0;
      transform: translateY(10px);
    }

    .chapter-block.motion-enter-active .verse-row,
    .chapter-block.motion-enter-active .chapter-block-title {
      opacity: 1;
      transform: translateY(0);
      transition:
        opacity var(--dur-enter) var(--ease-standard),
        transform var(--dur-enter) var(--ease-standard);
    }

    .verse-row.verse-pulse {
      box-shadow: inset 0 0 0 9999px color-mix(in srgb, var(--accent) 11%, transparent);
      animation: versePulse var(--dur-fast) var(--ease-emphasized);
    }

    @keyframes versePulse {
      0% { box-shadow: inset 0 0 0 9999px color-mix(in srgb, var(--accent) 0%, transparent); }
      50% { box-shadow: inset 0 0 0 9999px color-mix(in srgb, var(--accent) 14%, transparent); }
      100% { box-shadow: inset 0 0 0 9999px color-mix(in srgb, var(--accent) 0%, transparent); }
    }

    .chapter-loading-indicator {
      position: relative;
      overflow: hidden;
      padding: 10px 12px;
      border-top: 1px solid var(--row-line);
      color: var(--muted);
      font-size: 0.82rem;
      background: color-mix(in srgb, var(--panel) 92%, var(--bg) 8%);
    }

    .chapter-loading-indicator::after {
      content: "";
      position: absolute;
      inset: 0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, color-mix(in srgb, var(--accent) 20%, transparent), transparent);
      animation: loadingSweep 1200ms linear infinite;
    }

    .chapter-loading-indicator.error {
      cursor: pointer;
      color: var(--accent);
      font-weight: 700;
    }

    .chapter-loading-indicator.error::after {
      display: none;
    }

    @keyframes loadingSweep {
      to { transform: translateX(100%); }
    }

    .translation {
      display: grid;
      gap: 2px;
    }

    .tag {
      font-size: 0.73rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-weight: 700;
    }

    .tag.nasb { color: var(--accent); }
    .tag.cunp { color: var(--accent-2); }

    .verse-text {
      line-height: 1.5;
      font-size: var(--verse-font-size);
      word-break: break-word;
    }

    .verse-text .entity {
      color: var(--entity-color);
      font-weight: 700;
    }

    .missing {
      color: var(--missing-color);
      font-style: italic;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--modal-overlay);
      z-index: 20;
      padding: 16px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity var(--dur-fast) var(--ease-standard);
    }

    .modal-backdrop.open {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    .modal-backdrop.closing {
      opacity: 0;
      visibility: visible;
      pointer-events: none;
    }

    .modal {
      width: min(460px, 100%);
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 22px 18px;
      box-shadow: 0 14px 40px rgba(10, 40, 80, 0.22);
      text-align: center;
      color: var(--text);
      font-size: 1.05rem;
      font-weight: 600;
      opacity: 0;
      transform: scale(0.96);
      transition: opacity var(--dur-fast) var(--ease-standard), transform var(--dur-fast) var(--ease-emphasized), background var(--dur-fast) var(--ease-standard), border-color var(--dur-fast) var(--ease-standard), color var(--dur-fast) var(--ease-standard);
    }

    .modal-backdrop.open .modal {
      opacity: 1;
      transform: scale(1);
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%) translateY(8px);
      background: var(--surface-solid);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 0.85rem;
      font-weight: 700;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--dur-fast) var(--ease-standard), transform var(--dur-fast) var(--ease-standard), background var(--dur-fast) var(--ease-standard), border-color var(--dur-fast) var(--ease-standard), color var(--dur-fast) var(--ease-standard);
      z-index: 30;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    @media (max-width: 760px) {
      .controls {
        grid-template-columns: 1fr;
      }

      .chapter-controls {
        justify-content: flex-start;
      }

      .font-controls {
        display: none;
      }

      body.mobile-at-top .font-controls {
        display: flex;
        justify-content: flex-start;
      }

      .verse-row {
        grid-template-columns: 46px 1fr;
      }

      .verse-content {
        padding: 10px;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 1ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 1ms !important;
        scroll-behavior: auto !important;
      }

      .chapter-block.motion-enter .verse-row,
      .chapter-block.motion-enter .chapter-block-title {
        opacity: 1;
        transform: none;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <header class="header">
      <h1 id="appTitle" class="title">Interlaced NASB+CUNP Bible</h1>
    </header>

    <section class="controls" aria-label="Controls">
      <select id="bookSelect" disabled aria-label="Book"></select>
      <div class="chapter-controls" aria-label="Chapter navigation controls">
        <button id="chapterPrev" class="font-btn chapter-btn" type="button" aria-label="Previous chapter">&larr;</button>
        <select id="chapterSelect" class="chapter-picker" disabled aria-label="Chapter"></select>
        <button id="chapterNext" class="font-btn chapter-btn" type="button" aria-label="Next chapter">&rarr;</button>
      </div>
      <div class="font-controls" aria-label="Font size controls">
        <button id="fontDown" class="font-btn" type="button" aria-label="Decrease font size">A-</button>
        <button id="fontUp" class="font-btn" type="button" aria-label="Increase font size">A+</button>
        <button id="themeToggle" class="font-btn" type="button" aria-label="Switch to dark mode" title="Switch to dark mode">&#127769;</button>
      </div>
    </section>

    <section id="verses" class="verses" aria-live="polite"></section>
    <div id="scrollSentinel" aria-hidden="true"></div>
  </main>

  <div id="titleModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Dedication">
      for my loving wife ‚ù§Ô∏è Acts 17:11 
    </div>
  </div>

  <div id="copyToast" class="toast" role="status" aria-live="polite">Copied üìã</div>

  <script>
    (function () {
      const BOOKS = [
        { id: 1, en: 'Genesis', zh: 'Ââµ‰∏ñË®ò' },
        { id: 2, en: 'Exodus', zh: 'Âá∫ÂüÉÂèäË®ò' },
        { id: 3, en: 'Leviticus', zh: 'Âà©Êú™Ë®ò' },
        { id: 4, en: 'Numbers', zh: 'Ê∞ëÊï∏Ë®ò' },
        { id: 5, en: 'Deuteronomy', zh: 'Áî≥ÂëΩË®ò' },
        { id: 6, en: 'Joshua', zh: 'Á¥ÑÊõ∏‰∫ûË®ò' },
        { id: 7, en: 'Judges', zh: 'Â£´Â∏´Ë®ò' },
        { id: 8, en: 'Ruth', zh: 'Ë∑ØÂæóË®ò' },
        { id: 9, en: '1 Samuel', zh: 'ÊííÊØçËÄ≥Ë®ò‰∏ä' },
        { id: 10, en: '2 Samuel', zh: 'ÊííÊØçËÄ≥Ë®ò‰∏ã' },
        { id: 11, en: '1 Kings', zh: 'ÂàóÁéãÁ¥Ä‰∏ä' },
        { id: 12, en: '2 Kings', zh: 'ÂàóÁéãÁ¥Ä‰∏ã' },
        { id: 13, en: '1 Chronicles', zh: 'Ê≠∑‰ª£Âøó‰∏ä' },
        { id: 14, en: '2 Chronicles', zh: 'Ê≠∑‰ª£Âøó‰∏ã' },
        { id: 15, en: 'Ezra', zh: '‰ª•ÊñØÊãâË®ò' },
        { id: 16, en: 'Nehemiah', zh: 'Â∞ºÂ∏åÁ±≥Ë®ò' },
        { id: 17, en: 'Esther', zh: '‰ª•ÊñØÂ∏ñË®ò' },
        { id: 18, en: 'Job', zh: 'Á¥Ñ‰ºØË®ò' },
        { id: 19, en: 'Psalms', zh: 'Ë©©ÁØá' },
        { id: 20, en: 'Proverbs', zh: 'ÁÆ¥Ë®Ä' },
        { id: 21, en: 'Ecclesiastes', zh: 'ÂÇ≥ÈÅìÊõ∏' },
        { id: 22, en: 'Song of Solomon', zh: 'ÈõÖÊ≠å' },
        { id: 23, en: 'Isaiah', zh: '‰ª•Ë≥Ω‰∫ûÊõ∏' },
        { id: 24, en: 'Jeremiah', zh: 'ËÄ∂Âà©Á±≥Êõ∏' },
        { id: 25, en: 'Lamentations', zh: 'ËÄ∂Âà©Á±≥ÂìÄÊ≠å' },
        { id: 26, en: 'Ezekiel', zh: '‰ª•Ë•øÁµêÊõ∏' },
        { id: 27, en: 'Daniel', zh: '‰ΩÜ‰ª•ÁêÜÊõ∏' },
        { id: 28, en: 'Hosea', zh: '‰ΩïË•øÈòøÊõ∏' },
        { id: 29, en: 'Joel', zh: 'Á¥ÑÁè•Êõ∏' },
        { id: 30, en: 'Amos', zh: 'ÈòøÊë©Âè∏Êõ∏' },
        { id: 31, en: 'Obadiah', zh: '‰øÑÂ∑¥Â∫ï‰∫ûÊõ∏' },
        { id: 32, en: 'Jonah', zh: 'Á¥ÑÊãøÊõ∏' },
        { id: 33, en: 'Micah', zh: 'ÂΩåËø¶Êõ∏' },
        { id: 34, en: 'Nahum', zh: 'ÈÇ£È¥ªÊõ∏' },
        { id: 35, en: 'Habakkuk', zh: 'ÂìàÂ∑¥Ë∞∑Êõ∏' },
        { id: 36, en: 'Zephaniah', zh: 'Ë•øÁï™ÈõÖÊõ∏' },
        { id: 37, en: 'Haggai', zh: 'ÂìàË©≤Êõ∏' },
        { id: 38, en: 'Zechariah', zh: 'ÊííËø¶Âà©‰∫ûÊõ∏' },
        { id: 39, en: 'Malachi', zh: 'Áë™ÊãâÂü∫Êõ∏' },
        { id: 40, en: 'Matthew', zh: 'È¶¨Â§™Á¶èÈü≥' },
        { id: 41, en: 'Mark', zh: 'È¶¨ÂèØÁ¶èÈü≥' },
        { id: 42, en: 'Luke', zh: 'Ë∑ØÂä†Á¶èÈü≥' },
        { id: 43, en: 'John', zh: 'Á¥ÑÁø∞Á¶èÈü≥' },
        { id: 44, en: 'Acts', zh: '‰ΩøÂæíË°åÂÇ≥' },
        { id: 45, en: 'Romans', zh: 'ÁæÖÈ¶¨Êõ∏' },
        { id: 46, en: '1 Corinthians', zh: 'Âì•ÊûóÂ§öÂâçÊõ∏' },
        { id: 47, en: '2 Corinthians', zh: 'Âì•ÊûóÂ§öÂæåÊõ∏' },
        { id: 48, en: 'Galatians', zh: 'Âä†ÊãâÂ§™Êõ∏' },
        { id: 49, en: 'Ephesians', zh: '‰ª•ÂºóÊâÄÊõ∏' },
        { id: 50, en: 'Philippians', zh: 'ËÖìÁ´ãÊØîÊõ∏' },
        { id: 51, en: 'Colossians', zh: 'Ê≠åÁæÖË•øÊõ∏' },
        { id: 52, en: '1 Thessalonians', zh: 'Â∏ñÊííÁæÖÂ∞ºËø¶ÂâçÊõ∏' },
        { id: 53, en: '2 Thessalonians', zh: 'Â∏ñÊííÁæÖÂ∞ºËø¶ÂæåÊõ∏' },
        { id: 54, en: '1 Timothy', zh: 'ÊèêÊë©Â§™ÂâçÊõ∏' },
        { id: 55, en: '2 Timothy', zh: 'ÊèêÊë©Â§™ÂæåÊõ∏' },
        { id: 56, en: 'Titus', zh: 'ÊèêÂ§öÊõ∏' },
        { id: 57, en: 'Philemon', zh: 'ËÖìÂà©ÈñÄÊõ∏' },
        { id: 58, en: 'Hebrews', zh: 'Â∏å‰ºØ‰æÜÊõ∏' },
        { id: 59, en: 'James', zh: 'ÈõÖÂêÑÊõ∏' },
        { id: 60, en: '1 Peter', zh: 'ÂΩºÂæóÂâçÊõ∏' },
        { id: 61, en: '2 Peter', zh: 'ÂΩºÂæóÂæåÊõ∏' },
        { id: 62, en: '1 John', zh: 'Á¥ÑÁø∞‰∏ÄÊõ∏' },
        { id: 63, en: '2 John', zh: 'Á¥ÑÁø∞‰∫åÊõ∏' },
        { id: 64, en: '3 John', zh: 'Á¥ÑÁø∞‰∏âÊõ∏' },
        { id: 65, en: 'Jude', zh: 'Áå∂Â§ßÊõ∏' },
        { id: 66, en: 'Revelation', zh: 'ÂïüÁ§∫ÈåÑ' }
      ];

      const state = {
        assetBasePath: null,
        nasbIndex: null,
        cunpIndex: null,
        loadedScriptKeys: new Set(),
        activeSessionId: 0,
        lastLoadedChapterRef: null,
        isLoadingMore: false
      };
      const FONT_STORAGE_KEY = 'interlaced_font_size_rem';
      const LOCATION_STORAGE_KEY = 'interlaced_reading_location';
      const THEME_STORAGE_KEY = 'interlaced_theme';
      const FONT_MIN = 0.85;
      const FONT_STEP = 0.05;
      const FONT_DEFAULT = 0.97;
      const VERSE_STAGGER_MS = 14;
      const VERSE_STAGGER_CAP_MS = 140;
      const PULSE_MS = 300;
      const MODAL_CLOSE_MS = 180;

      const controlsEl = document.querySelector('.controls');
      const bookSelect = document.getElementById('bookSelect');
      const chapterSelect = document.getElementById('chapterSelect');
      const appTitleEl = document.getElementById('appTitle');
      const titleModalBackdropEl = document.getElementById('titleModalBackdrop');
      const chapterPrevBtn = document.getElementById('chapterPrev');
      const chapterNextBtn = document.getElementById('chapterNext');
      const fontDownBtn = document.getElementById('fontDown');
      const fontUpBtn = document.getElementById('fontUp');
      const themeToggleBtn = document.getElementById('themeToggle');
      const versesEl = document.getElementById('verses');
      const scrollSentinelEl = document.getElementById('scrollSentinel');
      const copyToastEl = document.getElementById('copyToast');
      let copyToastTimer = null;
      let infiniteObserver = null;
      const mobileMediaQuery = window.matchMedia('(max-width: 760px)');
      const reducedMotionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
      let modalCloseTimer = null;
      let chapterSyncFramePending = false;

      function openTitleModal() {
        if (modalCloseTimer !== null) {
          clearTimeout(modalCloseTimer);
          modalCloseTimer = null;
        }
        titleModalBackdropEl.classList.remove('closing');
        titleModalBackdropEl.classList.add('open');
        titleModalBackdropEl.setAttribute('aria-hidden', 'false');
      }

      function closeTitleModal() {
        if (!titleModalBackdropEl.classList.contains('open')) {
          return;
        }
        titleModalBackdropEl.classList.remove('open');
        titleModalBackdropEl.classList.add('closing');
        modalCloseTimer = setTimeout(() => {
          titleModalBackdropEl.classList.remove('closing');
          titleModalBackdropEl.setAttribute('aria-hidden', 'true');
          modalCloseTimer = null;
        }, MODAL_CLOSE_MS);
      }

      function getSystemTheme() {
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      function updateThemeToggleLabel(theme) {
        if (theme === 'dark') {
          themeToggleBtn.innerHTML = '&#9728;';
          themeToggleBtn.setAttribute('aria-label', 'Switch to light mode');
          themeToggleBtn.setAttribute('title', 'Switch to light mode');
        } else {
          themeToggleBtn.innerHTML = '&#127769;';
          themeToggleBtn.setAttribute('aria-label', 'Switch to dark mode');
          themeToggleBtn.setAttribute('title', 'Switch to dark mode');
        }
      }

      function applyTheme(theme) {
        const resolvedTheme = theme === 'dark' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', resolvedTheme);
        updateThemeToggleLabel(resolvedTheme);
      }

      function loadInitialTheme() {
        let theme = null;
        try {
          theme = localStorage.getItem(THEME_STORAGE_KEY);
        } catch {
          // ignore storage failures
        }
        if (theme !== 'light' && theme !== 'dark') {
          theme = getSystemTheme();
        }
        applyTheme(theme);
      }

      function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        try {
          localStorage.setItem(THEME_STORAGE_KEY, next);
        } catch {
          // ignore storage failures
        }
      }

      function updateMobileTopControlsVisibility() {
        controlsEl.classList.toggle('scrolled', window.scrollY > 12);
        if (!mobileMediaQuery.matches) {
          document.body.classList.remove('mobile-at-top');
          return;
        }
        document.body.classList.toggle('mobile-at-top', window.scrollY <= 12);
      }

      function syncSelectorsToChapterRef(bookId, chapterId) {
        if (!bookId || !chapterId || !state.nasbIndex) {
          return;
        }
        const currentBookId = String(bookSelect.value || '');
        const currentChapterId = String(chapterSelect.value || '');
        if (currentBookId === String(bookId) && currentChapterId === String(chapterId)) {
          return;
        }

        if (currentBookId !== String(bookId)) {
          bookSelect.value = String(bookId);
          populateChapterSelect(bookSelect.value);
        }
        chapterSelect.value = String(chapterId);
        updateChapterNavButtons();
        saveReadingLocation();
      }

      function syncCurrentChapterFromViewport() {
        const chapterBlocks = versesEl.querySelectorAll('.chapter-block[data-book-id][data-chapter-id]');
        if (!chapterBlocks.length) {
          return;
        }
        const pivot = window.innerHeight * 0.35;
        let activeBlock = chapterBlocks[0];
        for (const block of chapterBlocks) {
          if (block.getBoundingClientRect().top <= pivot) {
            activeBlock = block;
            continue;
          }
          break;
        }
        syncSelectorsToChapterRef(activeBlock.dataset.bookId, activeBlock.dataset.chapterId);
      }

      function scheduleViewportChapterSync() {
        if (chapterSyncFramePending) {
          return;
        }
        chapterSyncFramePending = true;
        requestAnimationFrame(() => {
          chapterSyncFramePending = false;
          syncCurrentChapterFromViewport();
        });
      }

      function clampFontSize(value) {
        return Math.max(FONT_MIN, value);
      }

      function applyFontSize(size) {
        const clamped = clampFontSize(size);
        document.documentElement.style.setProperty('--verse-font-size', `${clamped.toFixed(2)}rem`);
        try {
          localStorage.setItem(FONT_STORAGE_KEY, String(clamped));
        } catch {
          // ignore storage failures
        }
      }

      function loadInitialFontSize() {
        let size = FONT_DEFAULT;
        try {
          const raw = localStorage.getItem(FONT_STORAGE_KEY);
          const parsed = raw === null ? NaN : Number.parseFloat(raw);
          if (Number.isFinite(parsed)) {
            size = parsed;
          }
        } catch {
          // ignore storage failures
        }
        applyFontSize(size);
      }

      function adjustFontSize(delta) {
        const current = Number.parseFloat(
          getComputedStyle(document.documentElement).getPropertyValue('--verse-font-size')
        );
        const fallback = Number.isFinite(current) ? current : FONT_DEFAULT;
        applyFontSize(fallback + delta);
      }

      function saveReadingLocation() {
        if (!bookSelect.value || !chapterSelect.value) {
          return;
        }
        try {
          localStorage.setItem(
            LOCATION_STORAGE_KEY,
            JSON.stringify({
              bookId: String(bookSelect.value),
              chapterId: String(chapterSelect.value)
            })
          );
        } catch {
          // ignore storage failures
        }
      }

      function loadSavedReadingLocation() {
        try {
          const raw = localStorage.getItem(LOCATION_STORAGE_KEY);
          if (!raw) {
            return null;
          }
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object') {
            return null;
          }
          if (!parsed.bookId || !parsed.chapterId) {
            return null;
          }
          return {
            bookId: String(parsed.bookId),
            chapterId: String(parsed.chapterId)
          };
        } catch {
          return null;
        }
      }

      function clearVerses() {
        if (infiniteObserver) {
          infiniteObserver.disconnect();
          infiniteObserver = null;
        }
        versesEl.innerHTML = '';
      }

      async function readJsonWithFetch(url) {
        const response = await fetch(url, { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Failed to load ${url} (${response.status})`);
        }
        return response.json();
      }

      async function readJsonWithXhr(url) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', url, true);
          xhr.responseType = 'text';
          xhr.onload = function () {
            if (xhr.status === 0 || (xhr.status >= 200 && xhr.status < 300)) {
              try {
                resolve(JSON.parse(xhr.responseText));
              } catch {
                reject(new Error(`Invalid JSON in ${url}`));
              }
              return;
            }
            reject(new Error(`Failed to load ${url} (${xhr.status})`));
          };
          xhr.onerror = function () {
            reject(new Error(`Network error while loading ${url}`));
          };
          xhr.send();
        });
      }

      function relJsonToKey(relPath) {
        return relPath.replace(/\.json$/i, '');
      }

      function ensureAssetStore() {
        if (!window.__BIBLE_APP_ASSETS) {
          window.__BIBLE_APP_ASSETS = Object.create(null);
        }
        return window.__BIBLE_APP_ASSETS;
      }

      async function loadScriptAsset(relPath) {
        const key = relJsonToKey(relPath);
        const store = ensureAssetStore();
        if (Object.prototype.hasOwnProperty.call(store, key)) {
          return store[key];
        }

        const url = `${state.assetBasePath}/${key}.js`;
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = url;
          script.async = true;
          script.onload = () => resolve();
          script.onerror = () => reject(new Error(`Script load failed: ${url}`));
          document.head.appendChild(script);
        });

        state.loadedScriptKeys.add(key);

        if (!Object.prototype.hasOwnProperty.call(store, key)) {
          throw new Error(`Asset key missing after script load: ${key}`);
        }
        return store[key];
      }

      async function fetchJson(relPath) {
        if (!state.assetBasePath) {
          throw new Error('Asset base path not resolved.');
        }
        const url = `${state.assetBasePath}/${relPath}`;

        try {
          return await readJsonWithFetch(url);
        } catch (fetchError) {
          try {
            return await readJsonWithXhr(url);
          } catch {
            try {
              return await loadScriptAsset(relPath);
            } catch {
              throw fetchError;
            }
          }
        }
      }

      async function detectAssetBasePath() {
        const candidates = ['assets', './assets', '../assets'];
        for (const base of candidates) {
          try {
            state.assetBasePath = base;
            await fetchJson('nasb/index.json');
            await fetchJson('cunp/index.json');
            if (state.assetBasePath) {
              return base;
            }
          } catch {
            // continue trying other candidate paths
          }
        }
        throw new Error('Could not find readable assets path. Keep index.html next to assets folder.');
      }

      function getBookLabel(bookNumber) {
        const book = BOOKS.find((b) => b.id === Number(bookNumber));
        if (!book) {
          return `Book ${bookNumber}`;
        }
        return `${book.en} (${book.zh})`;
      }

      function populateBookSelect() {
        bookSelect.innerHTML = '';
        for (const book of state.nasbIndex.books) {
          const option = document.createElement('option');
          option.value = book.bookId;
          option.textContent = getBookLabel(book.book);
          bookSelect.appendChild(option);
        }
        bookSelect.disabled = false;
      }

      function restoreReadingLocation() {
        const saved = loadSavedReadingLocation();
        if (!saved || !state.nasbIndex || !Array.isArray(state.nasbIndex.books)) {
          return false;
        }

        const savedBook = state.nasbIndex.books.find((book) => String(book.bookId) === saved.bookId);
        if (!savedBook) {
          return false;
        }

        bookSelect.value = saved.bookId;
        populateChapterSelect(bookSelect.value);

        const savedChapter = savedBook.chapters.find((chapter) => String(chapter.chapterId) === saved.chapterId);
        if (!savedChapter) {
          return false;
        }

        chapterSelect.value = saved.chapterId;
        updateChapterNavButtons();
        return true;
      }

      function getBookEntry(indexData, bookId) {
        return indexData.books.find((book) => book.bookId === bookId) || null;
      }

      function populateChapterSelect(bookId) {
        const nasbBook = getBookEntry(state.nasbIndex, bookId);
        chapterSelect.innerHTML = '';
        if (!nasbBook) {
          chapterSelect.disabled = true;
          chapterPrevBtn.disabled = true;
          chapterNextBtn.disabled = true;
          return;
        }

        for (const chapter of nasbBook.chapters) {
          const option = document.createElement('option');
          option.value = chapter.chapterId;
          option.textContent = `Chapter ${chapter.chapter}`;
          chapterSelect.appendChild(option);
        }

        chapterSelect.disabled = false;
        updateChapterNavButtons();
      }

      function getCurrentBookPosition() {
        if (!state.nasbIndex || !Array.isArray(state.nasbIndex.books)) {
          return -1;
        }
        return state.nasbIndex.books.findIndex((book) => String(book.bookId) === String(bookSelect.value));
      }

      function getCurrentChapterPosition(bookEntry) {
        if (!bookEntry || !Array.isArray(bookEntry.chapters)) {
          return -1;
        }
        return bookEntry.chapters.findIndex((chapter) => String(chapter.chapterId) === String(chapterSelect.value));
      }

      function updateChapterNavButtons() {
        const bookPos = getCurrentBookPosition();
        if (bookPos < 0) {
          chapterPrevBtn.disabled = true;
          chapterNextBtn.disabled = true;
          return;
        }

        const bookEntry = state.nasbIndex.books[bookPos];
        const chapterPos = getCurrentChapterPosition(bookEntry);
        if (chapterPos < 0) {
          chapterPrevBtn.disabled = true;
          chapterNextBtn.disabled = true;
          return;
        }

        const hasPrevChapter = chapterPos > 0 || bookPos > 0;
        const hasNextChapter =
          chapterPos < bookEntry.chapters.length - 1 || bookPos < state.nasbIndex.books.length - 1;

        chapterPrevBtn.disabled = !hasPrevChapter;
        chapterNextBtn.disabled = !hasNextChapter;
      }

      async function navigateChapter(direction) {
        if (!state.nasbIndex || !state.nasbIndex.books.length) {
          return;
        }

        const bookPos = getCurrentBookPosition();
        if (bookPos < 0) {
          return;
        }

        const currentBook = state.nasbIndex.books[bookPos];
        const chapterPos = getCurrentChapterPosition(currentBook);
        if (chapterPos < 0) {
          return;
        }

        let nextBookPos = bookPos;
        let nextChapterPos = chapterPos + direction;

        if (nextChapterPos < 0) {
          if (bookPos === 0) {
            return;
          }
          nextBookPos = bookPos - 1;
          nextChapterPos = state.nasbIndex.books[nextBookPos].chapters.length - 1;
        } else if (nextChapterPos >= currentBook.chapters.length) {
          if (bookPos >= state.nasbIndex.books.length - 1) {
            return;
          }
          nextBookPos = bookPos + 1;
          nextChapterPos = 0;
        }

        const nextBook = state.nasbIndex.books[nextBookPos];
        const nextChapter = nextBook.chapters[nextChapterPos];
        if (!nextBook || !nextChapter) {
          return;
        }

        if (String(bookSelect.value) !== String(nextBook.bookId)) {
          bookSelect.value = String(nextBook.bookId);
          populateChapterSelect(bookSelect.value);
        }

        chapterSelect.value = String(nextChapter.chapterId);
        updateChapterNavButtons();
        await renderCurrentChapter();
      }

      async function jumpToBookChapter(bookNumber, chapterNumber) {
        if (!state.nasbIndex || !Array.isArray(state.nasbIndex.books)) {
          return;
        }

        const targetBook = state.nasbIndex.books.find((book) => Number(book.book) === Number(bookNumber));
        if (!targetBook) {
          return;
        }

        bookSelect.value = String(targetBook.bookId);
        populateChapterSelect(bookSelect.value);

        const targetChapter = targetBook.chapters.find((chapter) => Number(chapter.chapter) === Number(chapterNumber));
        if (!targetChapter) {
          return;
        }

        chapterSelect.value = String(targetChapter.chapterId);
        updateChapterNavButtons();
        await renderCurrentChapter();
      }

      function scrollToVerse(verseNumber) {
        const verseRow = versesEl.querySelector(`.verse-row[data-verse-number="${verseNumber}"]`);
        if (!verseRow) {
          return;
        }
        verseRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function wait(ms) {
        return new Promise((resolve) => {
          setTimeout(resolve, ms);
        });
      }

      async function loadChapterVerses(translation, bookId, chapterId) {
        const indexData = translation === 'nasb' ? state.nasbIndex : state.cunpIndex;
        const book = getBookEntry(indexData, bookId);
        if (!book) {
          throw new Error(`Book ${bookId} not found in ${translation.toUpperCase()} index.`);
        }

        const chapter = book.chapters.find((entry) => entry.chapterId === chapterId);
        if (!chapter) {
          return [];
        }

        const relPath = `${translation}/${chapter.path}`;
        try {
          const data = await fetchJson(relPath);
          return Array.isArray(data) ? data : [];
        } catch {
          return [];
        }
      }

      function buildInterlacedRows(nasbVerses, cunpVerses) {
        const nasbMap = new Map();
        const cunpMap = new Map();

        for (const verse of nasbVerses) {
          nasbMap.set(Number(verse.verse), verse.text || '');
        }

        for (const verse of cunpVerses) {
          cunpMap.set(Number(verse.verse), verse.text || '');
        }

        const verseNumbers = new Set([...nasbMap.keys(), ...cunpMap.keys()]);
        return [...verseNumbers]
          .sort((a, b) => a - b)
          .map((num) => ({
            verseNumber: num,
            nasbText: nasbMap.has(num) ? nasbMap.get(num) : null,
            cunpText: cunpMap.has(num) ? cunpMap.get(num) : null
          }));
      }

      function escapeHtml(text) {
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function renderVerseTextHtml(value) {
        const escaped = escapeHtml(value);
        return escaped
          .replace(/&lt;br\s*\/?&gt;/gi, '<br>')
          .replace(/&lt;i&gt;/gi, '<i>')
          .replace(/&lt;\/i&gt;/gi, '</i>')
          .replace(/&lt;sup&gt;/gi, '<sup>')
          .replace(/&lt;\/sup&gt;/gi, '</sup>')
          .replace(/&lt;e&gt;/gi, '<span class="entity">')
          .replace(/&lt;\/e&gt;/gi, '</span>');
      }

      function createTranslationBlock(tagClass, tagText, value) {
        const wrapper = document.createElement('div');
        wrapper.className = 'translation';

        const body = document.createElement('div');
        body.className = 'verse-text';
        if (value === null || value === '') {
          body.classList.add('missing');
          body.textContent = '(missing)';
        } else {
          body.innerHTML = renderVerseTextHtml(value);
        }

        wrapper.appendChild(body);
        return wrapper;
      }

      function formatVerseForCopy(row, bookNumber, chapterNumber) {
        const reference = `${getBookLabel(bookNumber)} ${chapterNumber}:${row.verseNumber}`;
        const nasbLine = `NASB: ${row.nasbText === null || row.nasbText === '' ? '(missing)' : row.nasbText}`;
        const cunpLine = `CUNP: ${row.cunpText === null || row.cunpText === '' ? '(missing)' : row.cunpText}`;
        return `${reference}\n${nasbLine}\n${cunpLine}`;
      }

      async function copyText(text) {
        try {
          if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
            await navigator.clipboard.writeText(text);
            return true;
          }
        } catch {
          // fall back to legacy copy path
        }

        try {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.setAttribute('readonly', '');
          textarea.style.position = 'fixed';
          textarea.style.left = '-9999px';
          document.body.appendChild(textarea);
          textarea.select();
          const ok = document.execCommand('copy');
          document.body.removeChild(textarea);
          return ok;
        } catch {
          return false;
        }
      }

      function showCopyToast() {
        if (copyToastTimer !== null) {
          clearTimeout(copyToastTimer);
        }
        copyToastEl.classList.add('show');
        copyToastTimer = setTimeout(() => {
          copyToastEl.classList.remove('show');
          copyToastTimer = null;
        }, 900);
      }

      async function handleCopyVerse(row, bookNumber, chapterNumber) {
        const ok = await copyText(formatVerseForCopy(row, bookNumber, chapterNumber));
        if (ok) {
          showCopyToast();
          if (navigator.vibrate) {
            try {
              navigator.vibrate(8);
            } catch {
              // ignore vibration failures
            }
          }
        }
        return ok;
      }

      function pulseVerseRow(verseRowEl) {
        verseRowEl.classList.remove('verse-pulse');
        void verseRowEl.offsetWidth;
        verseRowEl.classList.add('verse-pulse');
        setTimeout(() => {
          verseRowEl.classList.remove('verse-pulse');
        }, PULSE_MS);
      }

      function getChapterMeta(bookId, chapterId) {
        const bookEntry = getBookEntry(state.nasbIndex, bookId);
        if (!bookEntry) {
          return null;
        }
        const chapterEntry = bookEntry.chapters.find((entry) => String(entry.chapterId) === String(chapterId));
        if (!chapterEntry) {
          return null;
        }
        return {
          bookId: String(bookEntry.bookId),
          chapterId: String(chapterEntry.chapterId),
          bookNumber: Number(bookEntry.book),
          chapterNumber: Number(chapterEntry.chapter)
        };
      }

      function getNextChapterRef(bookId, chapterId) {
        const books = state.nasbIndex && Array.isArray(state.nasbIndex.books) ? state.nasbIndex.books : [];
        if (!books.length) {
          return null;
        }
        const bookPos = books.findIndex((book) => String(book.bookId) === String(bookId));
        if (bookPos < 0) {
          return null;
        }
        const chapters = books[bookPos].chapters || [];
        const chapterPos = chapters.findIndex((chapter) => String(chapter.chapterId) === String(chapterId));
        if (chapterPos < 0) {
          return null;
        }

        if (chapterPos < chapters.length - 1) {
          return {
            bookId: String(books[bookPos].bookId),
            chapterId: String(chapters[chapterPos + 1].chapterId)
          };
        }

        if (bookPos < books.length - 1) {
          return {
            bookId: String(books[bookPos + 1].bookId),
            chapterId: String(books[bookPos + 1].chapters[0].chapterId)
          };
        }

        return null;
      }

      function appendChapterSection(rows, meta) {
        const chapterBlock = document.createElement('section');
        chapterBlock.className = 'chapter-block motion-enter';
        chapterBlock.dataset.bookId = meta.bookId;
        chapterBlock.dataset.chapterId = meta.chapterId;

        const sectionTitle = document.createElement('h3');
        sectionTitle.className = 'chapter-block-title';
        sectionTitle.textContent = `${getBookLabel(meta.bookNumber)} - Chapter ${meta.chapterNumber}`;
        chapterBlock.appendChild(sectionTitle);

        if (!rows.length) {
          const empty = document.createElement('div');
          empty.className = 'verse-row';

          const no = document.createElement('div');
          no.className = 'verse-no';
          no.textContent = '-';

          const content = document.createElement('div');
          content.className = 'verse-content';
          const text = document.createElement('div');
          text.className = 'verse-text missing';
          text.textContent = 'No verses found in this chapter.';
          content.appendChild(text);

          empty.appendChild(no);
          empty.appendChild(content);
          chapterBlock.appendChild(empty);
          versesEl.appendChild(chapterBlock);
          if (!reducedMotionQuery.matches) {
            requestAnimationFrame(() => {
              chapterBlock.classList.add('motion-enter-active');
            });
          } else {
            chapterBlock.classList.add('motion-enter-active');
          }
          return chapterBlock;
        }

        const fragment = document.createDocumentFragment();
        rows.forEach((row, index) => {
          const verseRow = document.createElement('article');
          verseRow.className = 'verse-row';
          verseRow.dataset.verseNumber = String(row.verseNumber);
          verseRow.addEventListener('click', async () => {
            const copied = await handleCopyVerse(row, meta.bookNumber, meta.chapterNumber);
            if (copied) {
              pulseVerseRow(verseRow);
            }
          });
          if (!reducedMotionQuery.matches) {
            verseRow.style.transitionDelay = `${Math.min(index * VERSE_STAGGER_MS, VERSE_STAGGER_CAP_MS)}ms`;
          }

          const verseNo = document.createElement('div');
          verseNo.className = 'verse-no';
          verseNo.textContent = String(row.verseNumber);

          const content = document.createElement('div');
          content.className = 'verse-content';
          content.appendChild(createTranslationBlock('nasb', 'NASB', row.nasbText));
          content.appendChild(createTranslationBlock('cunp', 'CUNP', row.cunpText));

          verseRow.appendChild(verseNo);
          verseRow.appendChild(content);
          fragment.appendChild(verseRow);
        });
        chapterBlock.appendChild(fragment);
        versesEl.appendChild(chapterBlock);
        if (!reducedMotionQuery.matches) {
          requestAnimationFrame(() => {
            chapterBlock.classList.add('motion-enter-active');
          });
        } else {
          chapterBlock.classList.add('motion-enter-active');
        }
        return chapterBlock;
      }

      function removeLoadingIndicator() {
        const indicator = versesEl.querySelector('.chapter-loading-indicator');
        if (indicator) {
          indicator.remove();
        }
      }

      function showLoadingIndicator() {
        removeLoadingIndicator();
        const indicator = document.createElement('div');
        indicator.className = 'chapter-loading-indicator';
        indicator.textContent = 'Loading next chapter...';
        versesEl.appendChild(indicator);
        return indicator;
      }

      function showLoadingError(sessionId) {
        removeLoadingIndicator();
        const indicator = document.createElement('div');
        indicator.className = 'chapter-loading-indicator error';
        indicator.textContent = 'Could not load next chapter. Tap to retry.';
        indicator.addEventListener('click', async () => {
          if (sessionId !== state.activeSessionId) {
            return;
          }
          indicator.remove();
          await maybeLoadNextChapter(sessionId);
        });
        versesEl.appendChild(indicator);
      }

      async function appendChapterByRef(chapterRef, sessionId) {
        if (sessionId !== state.activeSessionId) {
          return false;
        }
        const meta = getChapterMeta(chapterRef.bookId, chapterRef.chapterId);
        if (!meta) {
          return false;
        }

        const [nasbVerses, cunpVerses] = await Promise.all([
          loadChapterVerses('nasb', meta.bookId, meta.chapterId),
          loadChapterVerses('cunp', meta.bookId, meta.chapterId)
        ]);
        if (sessionId !== state.activeSessionId) {
          return false;
        }

        const rows = buildInterlacedRows(nasbVerses, cunpVerses);
        appendChapterSection(rows, meta);
        state.lastLoadedChapterRef = { bookId: meta.bookId, chapterId: meta.chapterId };
        return true;
      }

      async function maybeLoadNextChapter(sessionId) {
        if (state.isLoadingMore || sessionId !== state.activeSessionId || !state.lastLoadedChapterRef) {
          return;
        }
        const nextRef = getNextChapterRef(state.lastLoadedChapterRef.bookId, state.lastLoadedChapterRef.chapterId);
        if (!nextRef) {
          removeLoadingIndicator();
          return;
        }
        state.isLoadingMore = true;
        showLoadingIndicator();
        try {
          const ok = await appendChapterByRef(nextRef, sessionId);
          if (ok) {
            removeLoadingIndicator();
          } else if (sessionId === state.activeSessionId) {
            showLoadingError(sessionId);
          }
        } catch {
          if (sessionId === state.activeSessionId) {
            showLoadingError(sessionId);
          }
        } finally {
          state.isLoadingMore = false;
        }
      }

      function resetInfiniteObserver() {
        if (infiniteObserver) {
          infiniteObserver.disconnect();
          infiniteObserver = null;
        }
      }

      function setupInfiniteObserver(sessionId) {
        resetInfiniteObserver();
        if (!('IntersectionObserver' in window)) {
          return;
        }
        infiniteObserver = new IntersectionObserver(
          async (entries) => {
            const visible = entries.some((entry) => entry.isIntersecting);
            if (!visible) {
              return;
            }
            await maybeLoadNextChapter(sessionId);
          },
          { root: null, rootMargin: '700px 0px', threshold: 0 }
        );
        infiniteObserver.observe(scrollSentinelEl);
      }

      async function renderCurrentChapter() {
        if (!state.nasbIndex || !state.cunpIndex) {
          return;
        }

        const bookId = bookSelect.value;
        const chapterId = chapterSelect.value;
        if (!bookId || !chapterId) {
          clearVerses();
          return;
        }

        const initialMeta = getChapterMeta(bookId, chapterId);
        if (!initialMeta) {
          clearVerses();
          return;
        }

        const sessionId = state.activeSessionId + 1;
        state.activeSessionId = sessionId;
        state.lastLoadedChapterRef = null;
        state.isLoadingMore = false;
        versesEl.innerHTML = '';
        removeLoadingIndicator();

        await appendChapterByRef({ bookId: initialMeta.bookId, chapterId: initialMeta.chapterId }, sessionId);
        setupInfiniteObserver(sessionId);
        syncSelectorsToChapterRef(initialMeta.bookId, initialMeta.chapterId);
        saveReadingLocation();
      }

      async function loadIndices() {
        const [nasbIndex, cunpIndex] = await Promise.all([
          fetchJson('nasb/index.json'),
          fetchJson('cunp/index.json')
        ]);

        if (!nasbIndex || !Array.isArray(nasbIndex.books)) {
          throw new Error('Invalid nasb/index.json format.');
        }

        if (!cunpIndex || !Array.isArray(cunpIndex.books)) {
          throw new Error('Invalid cunp/index.json format.');
        }

        state.nasbIndex = nasbIndex;
        state.cunpIndex = cunpIndex;
      }

      bookSelect.addEventListener('change', async () => {
        populateChapterSelect(bookSelect.value);
        await renderCurrentChapter();
      });

      chapterSelect.addEventListener('change', async () => {
        updateChapterNavButtons();
        await renderCurrentChapter();
      });

      chapterPrevBtn.addEventListener('click', async () => {
        await navigateChapter(-1);
      });

      chapterNextBtn.addEventListener('click', async () => {
        await navigateChapter(1);
      });

      fontDownBtn.addEventListener('click', () => {
        adjustFontSize(-FONT_STEP);
      });

      fontUpBtn.addEventListener('click', () => {
        adjustFontSize(FONT_STEP);
      });

      themeToggleBtn.addEventListener('click', () => {
        toggleTheme();
      });

      appTitleEl.addEventListener('click', () => {
        (async function () {
          await jumpToBookChapter(44, 17);
          scrollToVerse(11);
          await wait(450);
          openTitleModal();
        })();
      });

      titleModalBackdropEl.addEventListener('click', (event) => {
        if (event.target === titleModalBackdropEl) {
          closeTitleModal();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && titleModalBackdropEl.classList.contains('open')) {
          closeTitleModal();
        }
      });

      window.addEventListener('scroll', () => {
        updateMobileTopControlsVisibility();
        scheduleViewportChapterSync();
      }, { passive: true });
      window.addEventListener('resize', () => {
        updateMobileTopControlsVisibility();
        scheduleViewportChapterSync();
      });
      if (typeof mobileMediaQuery.addEventListener === 'function') {
        mobileMediaQuery.addEventListener('change', updateMobileTopControlsVisibility);
      } else if (typeof mobileMediaQuery.addListener === 'function') {
        mobileMediaQuery.addListener(updateMobileTopControlsVisibility);
      }

      clearVerses();
      loadInitialTheme();
      loadInitialFontSize();
      updateMobileTopControlsVisibility();
      scheduleViewportChapterSync();

      (async function init() {
        try {
          state.assetBasePath = await detectAssetBasePath();
          await loadIndices();
          populateBookSelect();
          if (!restoreReadingLocation()) {
            populateChapterSelect(bookSelect.value);
          }
          await renderCurrentChapter();
        } catch (error) {
          console.error(error);
          bookSelect.disabled = true;
          chapterSelect.disabled = true;
          chapterPrevBtn.disabled = true;
          chapterNextBtn.disabled = true;
        }
      })();
    })();
  </script>
</body>
</html>
